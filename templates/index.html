<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudGallery</title>
    <style>
        * { box-sizing: border-box; }
        :root { --primary: #3b82f6; --bg: #f8fafc; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg); color: #333; margin: 0; padding: 20px; 
            overflow-x: hidden;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .top-nav { display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .logout-btn { text-decoration: none; color: #ef4444; font-size: 13px; padding: 6px 12px; background: white; border: 1px solid #fee2e2; border-radius: 20px; transition: 0.2s; }
        .logout-btn:hover { background: #fef2f2; border-color: #fecaca; }
        
        .upload-section { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; margin-bottom: 30px; margin-top: 10px; }
        .btn { background: white; border: 2px solid var(--primary); color: var(--primary); padding: 10px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: var(--primary); color: white; }
        #fileInput { display: none; }
        #status { margin-top: 15px; color: #666; font-size: 14px; word-break: break-all; }
        
        /* Â§¥ÈÉ®Â∏ÉÂ±Ä */
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; width: 100%; }
        .header-title { margin: 0; }
        .refresh-btn { background: none; border: none; cursor: pointer; color: #64748b; font-size: 14px; display: flex; align-items: center; gap: 5px; padding: 8px 12px; border-radius: 6px; }
        .refresh-btn:hover { background: #f1f5f9; color: var(--primary); }
        
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; transition: 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .img-container { height: 160px; overflow: hidden; background: #eee; display: flex; align-items: center; justify-content: center; cursor: zoom-in; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; }
        .card-body { padding: 12px; display: flex; flex-direction: column; gap: 6px; }
        .file-name { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
        .meta-info { font-size: 10px; color: #999; display: flex; justify-content: space-between; }
        
        .copy-btn { background: #f1f5f9; border: none; padding: 6px; border-radius: 4px; color: #475569; font-size: 12px; cursor: pointer; width: 100%; margin-top: 5px; }
        .copy-btn:hover { background: #e2e8f0; color: #0f172a; }
        .copy-btn.primary { background: #eff6ff; color: #2563eb; }
        
        .delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.9); color: red; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; opacity: 0; font-weight: bold; transition: 0.2s; }
        .card:hover .delete-btn { opacity: 1; }
        
        /* Lightbox */
        .lightbox-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background-color: rgba(255, 255, 255, 0.4); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); flex-direction: column; justify-content: center; align-items: center; }
        .lb-main { flex: 1; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        .lb-img { max-width: 70%; max-height: 70%; object-fit: contain; transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); cursor: grab; border-radius: 8px; box-shadow: 0 30px 80px rgba(0,0,0,0.25); }
        .floating-close { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.05); color: #333; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; z-index: 1020; transition:0.2s; }
        .floating-close:hover { background: rgba(0,0,0,0.1); }
        .lb-bottom-container { width: 100%; display: flex; justify-content: center; position: absolute; bottom: 130px; pointer-events: none; z-index: 1010; }
        .lb-controls { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 8px 20px; border-radius: 50px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; gap: 15px; pointer-events: auto; align-items: center; }
        .lb-ctl-btn { background: transparent; border: none; color: #333; font-size: 16px; cursor: pointer; padding: 5px 10px; border-radius: 20px; transition: 0.2s; }
        .lb-ctl-btn:hover { background: rgba(0,0,0,0.05); }
        .divider { width: 1px; background: rgba(0,0,0,0.1); height: 20px; }
        .filmstrip-container { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; z-index: 1005; }
        .filmstrip { height: 70px; width: auto; max-width: 90vw; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 35px; border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 12px; padding: 0 20px; overflow-x: auto; scrollbar-width: none; }
        .filmstrip::-webkit-scrollbar { display: none; }
        .thumb { width: 44px; height: 44px; border-radius: 10px; object-fit: cover; cursor: pointer; flex-shrink: 0; opacity: 0.5; transform: scale(0.9); filter: grayscale(0.2); transition: all 0.3s ease; border: 2px solid transparent; }
        .thumb:hover { opacity: 0.9; }
        .thumb.active { opacity: 1; filter: grayscale(0); transform: scale(1.1); border: 2px solid #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
        @media (max-width: 600px) { .gallery-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-nav"><a href="/logout" class="logout-btn">üî¥ ÈÄÄÂá∫</a></div>
        <div class="upload-section">
            <h2 style="margin-top:0;">‚òÅÔ∏è CloudGallery</h2>
            <div class="upload-wrapper">
                <button class="btn" onclick="document.getElementById('fileInput').click()">Ôºã ‰∏ä‰º†ÂõæÁâá (Â§öÈÄâ)</button>
                <input type="file" id="fileInput" accept="image/*" multiple onchange="uploadFiles()">
            </div>
            <div id="status">ÂáÜÂ§áÂ∞±Áª™</div>
        </div>
        <div class="gallery-header">
            <h3 class="header-title">üñºÔ∏è ÂõæÁâáÂàóË°®</h3>
            <button class="refresh-btn" onclick="location.reload()">üîÑ Âà∑Êñ∞</button>
        </div>
        <div class="gallery-grid">
            {% for img in images %}
            <div class="card" id="card-{{ loop.index0 }}">
                <div class="img-container" onclick="openViewer({{ loop.index0 }})">
                    <img class="private-img" 
                         data-src="{{ img.raw_url }}" 
                         data-name="{{ img.name }}"
                         src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxIDEiPjwvc3ZnPg==" 
                         onload="loadPrivateImage(this)">
                </div>
                <button class="delete-btn" onclick="deleteImage('{{ img.name }}', {{ loop.index0 }})">√ó</button>
                <div class="card-body">
                    <div class="file-name" title="{{ img.name }}">{{ img.name }}</div>
                    <div class="meta-info"><span>{{ img.size_fmt }}</span><span class="res-tag">...</span></div>
                    
                    <button class="copy-btn primary" onclick="copyLink(this, '{{ img.raw_url }}')">üìã Â§çÂà∂Áõ¥Èìæ</button>
                    <button class="copy-btn" onclick="copyMarkdown(this, '{{ img.name }}', '{{ img.raw_url }}')">üìù Â§çÂà∂ Markdown</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="lightbox" class="lightbox-overlay" onclick="closeViewer(event)">
        <div class="floating-close" onclick="closeViewer()">√ó</div>
        <div class="lb-main"><img id="lb-img" class="lb-img" onclick="event.stopPropagation()"></div>
        <div class="lb-bottom-container">
            <div class="lb-controls" onclick="event.stopPropagation()">
                <button class="lb-ctl-btn" onclick="zoom(-0.2)" title="Áº©Â∞è">Ôºç</button>
                <button class="lb-ctl-btn" onclick="resetZoom()" title="1:1" style="font-size:14px">1:1</button>
                <button class="lb-ctl-btn" onclick="zoom(0.2)" title="ÊîæÂ§ß">Ôºã</button>
                <span class="divider"></span>
                <button class="lb-ctl-btn" onclick="copyCurrentLink(this)" title="Â§çÂà∂Áõ¥Èìæ">üîó</button>
            </div>
        </div>
        <div class="filmstrip-container"><div class="filmstrip" id="filmstrip" onclick="event.stopPropagation()"></div></div>
    </div>

    <script>
        // CFG.api_base Áé∞Âú®ÂåÖÂê´‰∫Ü /images
        const CFG = {
            token: "{{ config.token }}",
            repo: "{{ config.repo }}",
            branch: "{{ config.branch }}",
            api: "{{ config.api_base }}"
        };

        const galleryData = [
            {% for img in images %}
            { name: "{{img.name}}", url: "{{img.raw_url}}", view_url: "{{img.view_url}}" },
            {% endfor %}
        ];
        let curIdx = 0, scale = 1;

        function getFullUrl(path) {
            if (!path) return "";
            if (path.startsWith('http')) return path;
            return window.location.origin + path;
        }

        function showTick(btn) {
            if(!btn) return;
            const originalText = btn.innerText;
            if(btn.classList.contains('lb-ctl-btn')) {
                btn.innerText = '‚úÖ';
            } else {
                btn.innerText = '‚úÖ Â∑≤Â§çÂà∂';
            }
            setTimeout(() => {
                btn.innerText = originalText;
            }, 1500);
        }

        function copyLink(btn, txt) { 
            const fullLink = getFullUrl(txt);
            navigator.clipboard.writeText(fullLink); 
            showTick(btn);
        }
        
        function copyMarkdown(btn, n, u) { 
            const fullLink = getFullUrl(u);
            const md = `![${n}](${fullLink})`;
            navigator.clipboard.writeText(md); 
            showTick(btn);
        }
        
        function copyCurrentLink(btn) { 
            const item = galleryData[curIdx];
            const fullLink = getFullUrl(item.url);
            navigator.clipboard.writeText(fullLink);
            showTick(btn);
        }

        async function loadPrivateImage(imgObj) {
            const rawUrl = imgObj.getAttribute('data-src');
            if (!rawUrl) return;
            try {
                const res = await fetch(rawUrl); 
                if (res.ok) {
                    const blob = await res.blob();
                    const objectUrl = URL.createObjectURL(blob);
                    
                    // ÂõæÁâáÂä†ËΩΩÂÆåÂêéÊõ¥Êñ∞ÂàÜËæ®Áéá
                    imgObj.onload = () => updateRes(imgObj);
                    imgObj.src = objectUrl;
                    imgObj.style.opacity = '1';
                    
                    const found = galleryData.find(i => i.url === rawUrl);
                    if(found) found.blobUrl = objectUrl;
                }
            } catch (e) { console.error("Âä†ËΩΩÂ§±Ë¥•", e); }
        }

        async function uploadFiles() {
            const inp = document.getElementById('fileInput');
            if (!inp.files.length) return;
            const status = document.getElementById('status');
            
            status.innerText = `üöÄ ÂáÜÂ§áÁõ¥‰º† ${inp.files.length} Âº†ÂéüÂõæ...`;
            let successCount = 0;
            
            for (let file of inp.files) {
                const ext = file.name.substring(file.name.lastIndexOf('.'));
                const randomName = Math.random().toString(36).substring(2, 6) + (ext || '.jpg');
                
                try {
                    const base64Content = await toBase64(file);
                    const cleanContent = base64Content.split(',')[1]; 
                    
                    // CFG.api Â∑≤ÁªèÊåáÂêë /images Êñá‰ª∂Â§πÔºåÊâÄ‰ª•ËøôÈáåÁõ¥Êé•ÊãºÊé•Êñá‰ª∂ÂêçÂç≥ÂèØ
                    const url = `${CFG.api}/${randomName}`;
                    
                    const body = {
                        message: `Up ${randomName}`,
                        content: cleanContent,
                        branch: CFG.branch
                    };

                    status.innerText = `üì§ Ê≠£Âú®‰∏ä‰º†: ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)...`;

                    const res = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${CFG.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });

                    if (res.ok) {
                        successCount++;
                    } else {
                        status.innerText = `‚ùå ‰∏ä‰º†Â§±Ë¥•: ${res.status}`;
                        await new Promise(r => setTimeout(r, 1000));
                    }
                } catch (e) {
                    status.innerText = `‚ùå ÈîôËØØ: ${e.message}`;
                }
            }

            if (successCount > 0) {
                status.innerText = `‚úÖ ÂÖ®ÈÉ®ÊêûÂÆöÔºÅÊàêÂäü‰∏ä‰º† ${successCount} Âº†ÔºåÂà∑Êñ∞‰∏≠...`;
                setTimeout(() => location.reload(), 1500);
            }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function deleteImage(name, idx) {
            // Áõ¥Êé•Âà†Èô§Ôºå‰∏çÂºπÁ™ó
            const fd = new FormData(); fd.append('filename', name);
            const res = await fetch('/delete', { method: 'POST', body: fd });
            if ((await res.json()).status === 'success') document.getElementById('card-'+idx).remove();
        }

        function openViewer(idx) {
            curIdx = idx;
            const lb = document.getElementById('lightbox');
            const fs = document.getElementById('filmstrip');
            fs.innerHTML = '';
            galleryData.forEach((img, i) => {
                const t = document.createElement('img');
                t.src = img.url; t.className = `thumb ${i===idx?'active':''}`;
                t.onclick = () => showImage(i);
                fs.appendChild(t);
            });
            lb.style.display = 'flex';
            setTimeout(() => lb.style.opacity = '1', 10);
            showImage(idx);
        }

        function showImage(idx) {
            curIdx = idx; scale = 1;
            const img = document.getElementById('lb-img');
            const item = galleryData[idx];
            const src = item.blobUrl || item.url;
            img.src = src;
            img.style.transform = `scale(1)`;
            document.querySelectorAll('.thumb').forEach((t, i) => {
                t.className = `thumb ${i===idx?'active':''}`;
                if(i===idx) t.scrollIntoView({behavior:"smooth", inline:"center"});
            });
        }

        function closeViewer(e) { 
            if(!e || e.target === e.currentTarget || e.target.classList.contains('floating-close')) {
                document.getElementById('lightbox').style.display = 'none'; 
            }
        }
        function zoom(d) { scale += d; if(scale<0.1) scale=0.1; document.getElementById('lb-img').style.transform = `scale(${scale})`; }
        function resetZoom() { scale = 1; document.getElementById('lb-img').style.transform = `scale(1)`; }
        function updateRes(img) { if(img.naturalWidth) img.closest('.card').querySelector('.res-tag').innerText = img.naturalWidth+'x'+img.naturalHeight; }
        
        document.getElementById('lb-img').addEventListener('wheel', function(e) {
            e.preventDefault(); e.deltaY < 0 ? zoom(0.1) : zoom(-0.1);
        }, { passive: false });
    </script>
</body>
</html>
